workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_PROTECTED != "true"'
      when: never
    - when: always

stages:
  - build
  - test
  - check
  - package
  - smoketest
  - publish

default:
  tags:
    - exec-docker

.dind:
  tags:
    - exec-dind
  # see https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#tls-enabled
  # for image usage and settings for building with TLS and docker in docker
  image: docker:20.10.12
  services:
    - docker:20.10.12-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"

.kaniko-push:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CR_STAGE_HOST}\":{\"auth\":\"$(printf "%s:%s" "${CR_STAGE_USER}" "${CR_STAGE_PW}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - cp $CR_STAGE_CERT /kaniko/ssl/certs/additional-ca-cert-bundle.crt
    - DEST="-d $CR_STAGE_HOST/$CR_STAGE_PROJECT/$IMAGE_NAME:ci-$CI_PIPELINE_ID"
    - "[ $DOCKERFILE ] && KANIKO_DOCKERFILE=\"--dockerfile $DOCKERFILE\""
    - "BUILD_ARGS=$(printenv | sed -n 's/BUILD_ARG_/--build-arg=/p')"
    - /kaniko/executor --context `pwd`/$CONTEXT $KANIKO_DOCKERFILE $DEST $BUILD_ARGS

.crane-copy:
  image:
    name: gcr.io/go-containerregistry/crane:debug
    entrypoint: [""]
  script:
    - export SSL_CERT_FILE=$CR_STAGE_CERT
    - crane auth login -u "${CR_STAGE_USER}" -p "${CR_STAGE_PW}" ${CR_STAGE_HOST} 
    - crane auth login -u "${CR_PUBLIC_USER}" -p "${CR_PUBLIC_PW}" ${CR_PUBLIC_HOST}
    - SRC_IMAGE_TAG="$CR_STAGE_HOST/$CR_STAGE_PROJECT/$IMAGE_NAME:ci-$CI_PIPELINE_ID"
    - DEST_IMAGE="$CR_PUBLIC_HOST/$CR_PUBLIC_ORG/$IMAGE_NAME"
    - >
      if [ $IMAGE_TAG ]; then
        crane copy $SRC_IMAGE_TAG $DEST_IMAGE:$IMAGE_TAG
      elif [ $CI_COMMIT_TAG ]; then
        crane copy $SRC_IMAGE_TAG $DEST_IMAGE:$CI_COMMIT_TAG
      else
        TAG_NAME=$(echo $CI_COMMIT_REF_SLUG- | sed 's/^master-$//')
        crane copy $SRC_IMAGE_TAG $DEST_IMAGE:${TAG_NAME}latest
        crane copy $SRC_IMAGE_TAG $DEST_IMAGE:$TAG_NAME$CI_COMMIT_SHORT_SHA
      fi

include:
  - local: 'docs/.gitlab-ci.yml'
  - local: 'helm/.gitlab-ci.yml'
  - local: 'slo-checker/.gitlab-ci.yml'
  - local: 'theodolite/.gitlab-ci.yml'
  - local: 'theodolite-benchmarks/.gitlab-ci.yml'
  - local: 'utils/.gitlab-ci.yml'
